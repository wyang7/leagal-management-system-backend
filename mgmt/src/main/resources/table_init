-- 创建数据库
CREATE DATABASE IF NOT EXISTS management_system DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

USE management_system;

-- 角色表
create table management_system.role
(
    role_id      bigint auto_increment comment '角色ID'
        primary key,
    role_name    varchar(50)                         not null comment '角色名',
    role_type    varchar(20)                         not null comment '角色类型（管理员、调解员）',
    created_time timestamp default CURRENT_TIMESTAMP null comment '创建时间',
    updated_time timestamp default CURRENT_TIMESTAMP null on update CURRENT_TIMESTAMP comment '更新时间',
    constraint uk_role_name
        unique (role_name)
)
    comment '角色表' charset = utf8mb4;

ALTER TABLE management_system.role ADD COLUMN station VARCHAR(255) COMMENT '驻点信息';

-- 用户表
create table management_system.user
(
    user_id      bigint auto_increment comment '用户ID'
        primary key,
    username     varchar(50)                          not null comment '用户名',
    password     varchar(255)                         not null comment '密码（加密存储）',
    status       tinyint(1) default 1                 not null comment '账号状态（1-正常，0-禁用）',
    role_id      bigint                               null comment '关联角色ID',
    created_time timestamp  default CURRENT_TIMESTAMP null comment '创建时间',
    updated_time timestamp  default CURRENT_TIMESTAMP null on update CURRENT_TIMESTAMP comment '更新时间',
    constraint uk_username
        unique (username),
    constraint fk_user_role
        foreign key (role_id) references management_system.role (role_id)
)
    comment '用户表' charset = utf8mb4;

create index idx_role_id
    on management_system.user (role_id);

create index idx_username
    on management_system.user (username);


-- 任务表
create table management_system.task
(
    task_id      bigint auto_increment comment '任务ID'
        primary key,
    task_name    varchar(100)                          not null comment '任务名',
    created_time timestamp   default CURRENT_TIMESTAMP null comment '创建时间',
    updated_time timestamp   default CURRENT_TIMESTAMP null on update CURRENT_TIMESTAMP comment '更新时间',
    status       varchar(20) default '待领取'          not null comment '案件包状态：待领取、已领取',
    owner_id     bigint                                null comment '归属人ID',
    constraint uk_task_name
        unique (task_name)
)
    comment '任务表' charset = utf8mb4;

ALTER TABLE task ADD COLUMN station VARCHAR(20) COMMENT '驻点（九堡彭埠、本部、笕桥、总部）';


-- 案件表
create table management_system.case_info
(
    case_id            bigint auto_increment comment '案件ID'
        primary key,
    case_number        varchar(50)                           not null comment '案件号',
    case_name          varchar(100)                          not null comment '案件名',
    task_id            bigint                                null comment '绑定的任务ID',
    status             varchar(20)                           not null comment '案件状态：待发布->待领取->已领取->已完成',
    user_id            bigint                                null comment '案件绑定用户ID',
    created_time       timestamp default CURRENT_TIMESTAMP   null comment '创建时间',
    updated_time       timestamp default CURRENT_TIMESTAMP   null on update CURRENT_TIMESTAMP comment '更新时间',
    amount             decimal(10, 2)                        null comment '标的额（精确到小数点后两位）',
    completion_notes   text                                  null comment '案件完成情况说明',
    case_location      enum ('九堡', '彭埠', '笕桥', '本部') null comment '案件归属地',
    court_receive_time datetime                              null comment '法院收案时间',
    plaintiff_name     varchar(255)                          null comment '原告',
    defendant_name     varchar(255)                          null comment '被告',
    assistant_id       bigint                                null comment '案件助理ID（关联user表user_id）',
    return_reason      text                                  null comment '退回原因',
    constraint uk_case_number
        unique (case_number),
    constraint fk_case_task
        foreign key (task_id) references management_system.task (task_id)
            on delete set null,
    constraint fk_case_user
        foreign key (user_id) references management_system.user (user_id)
            on delete set null
)
    comment '案件表' charset = utf8mb4;

create index idx_status
    on management_system.case_info (status);

create index idx_task_id
    on management_system.case_info (task_id);

create index idx_user_id
    on management_system.case_info (user_id);

ALTER TABLE case_info ADD COLUMN judge VARCHAR(20) COMMENT '法官';

alter table case_info
    add pre_feedback text null;

alter table case_info
    add delay_reason text null;

alter table case_info add mediator_receive_time bigint null;


CREATE TABLE `case_flow_history` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `case_id` bigint(20) NOT NULL COMMENT '案件ID',
  `operator_id` bigint(20) NOT NULL COMMENT '操作人ID',
  `operator_name` varchar(50) NOT NULL COMMENT '操作人姓名',
  `action` varchar(50) NOT NULL COMMENT '操作动作（如：领取、预反馈、退回、完成等）',
  `before_status` varchar(50) DEFAULT NULL COMMENT '操作前状态',
  `after_status` varchar(50) NOT NULL COMMENT '操作后状态',
  `remarks` text COMMENT '操作备注（如退回原因、预反馈内容等）',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  PRIMARY KEY (`id`),
  KEY `idx_case_id` (`case_id`) COMMENT '案件ID索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='案件流转历史记录表';


-- 初始化角色数据
INSERT INTO role (role_name, role_type) VALUES
('系统管理员', '管理员'),
('初级调解员', '调解员'),
('高级调解员', '调解员');


ALTER TABLE `user` ADD COLUMN `password` varchar(255) NOT NULL COMMENT '密码（加密存储）' AFTER `username`, ADD COLUMN `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '账号状态（1-正常，0-禁用）' AFTER `password`;

-- 创建索引
CREATE INDEX idx_username ON `user`(`username`);

ALTER TABLE case_info
    -> ADD COLUMN amount DECIMAL(10, 2) NULL COMMENT '标的额（精确到小数点后两位）';

ALTER TABLE case_info
ADD COLUMN completion_notes TEXT NULL COMMENT '案件完成情况说明';


-- 添加案件归属地字段（枚举类型）
ALTER TABLE case_info ADD COLUMN case_location ENUM('九堡', '彭埠', '笕桥', '本部') COMMENT '案件归属地';

-- 添加法院收案时间字段（时间戳）
ALTER TABLE case_info ADD COLUMN court_receive_time DATETIME COMMENT '法院收案时间';

-- 添加原告字段
ALTER TABLE case_info ADD COLUMN plaintiff_name VARCHAR(255) COMMENT '原告';

-- 添加被告字段
ALTER TABLE case_info ADD COLUMN defendant_name VARCHAR(255) COMMENT '被告';

-- 添加案件助理ID字段（关联用户表）
ALTER TABLE case_info ADD COLUMN assistant_id BIGINT COMMENT '案件助理ID（关联user表user_id）';


ALTER TABLE task ADD COLUMN `status` VARCHAR(20) NOT NULL DEFAULT '待领取' COMMENT '案件包状态：待领取、已领取';


ALTER TABLE `task`
ADD COLUMN `owner_id` BIGINT(20) NULL COMMENT '归属人ID' AFTER `status`;

ALTER TABLE case_info ADD COLUMN return_reason TEXT NULL COMMENT '退回原因';
