<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.managementsystem.mapper.CaseInfoMapper">



    <update id="removeTaskId">
        UPDATE case_info
        SET task_id = NULL
        WHERE case_id = #{caseId}
    </update>

    <!-- 查询所有案件总数 -->
    <select id="countAllCases" resultType="int">
        SELECT COUNT(1)  FROM case_info c
        LEFT JOIN user u ON c.user_id = u.user_id
        LEFT JOIN user a ON c.assistant_id = a.user_id
        LEFT JOIN task t ON c.task_id = t.task_id
        WHERE 1=1
        <if test="caseName != null and caseName != ''">
            AND case_name LIKE CONCAT(#{caseName}, '%')
        </if>
        <!-- 多选状态优先，其次处理特殊标识，最后单状态 -->
        <if test="statusList != null and statusList.size() > 0">
            AND c.status IN
            <foreach collection="statusList" item="st" open="(" separator="," close=")">
                #{st}
            </foreach>
        </if>
        <if test="(statusList == null or statusList.size() == 0) and status != null and status != '' and status != '我的案件' and status != '我的待办'">
            AND c.status = #{status}
        </if>
        <if test="(statusList == null or statusList.size() == 0) and status != null and status != '' and status == '我的案件'">
            AND c.status NOT IN ('退回' ,'调解失败')
        </if>
        <if test="(statusList == null or statusList.size() == 0) and status != null and status != '' and status == '我的待办'">
            AND c.status NOT IN ('退回' ,'调解失败','结案')
        </if>
        <if test="caseNumber != null and caseNumber != ''">
            AND c.case_number LIKE CONCAT('%', #{caseNumber}, '%')
        </if>
        <if test="plaintiff != null and plaintiff != ''">
            AND c.plaintiff_name LIKE CONCAT('%', #{plaintiff}, '%')
        </if>
        <if test="defendant != null and defendant != ''">
            AND c.defendant_name LIKE CONCAT('%', #{defendant}, '%')
        </if>
        <if test="receiveTimeStart != null and receiveTimeStart != ''">
            AND c.court_receive_time &gt;= #{receiveTimeStart}
        </if>
        <if test="receiveTimeEnd != null and receiveTimeEnd != ''">
            AND c.court_receive_time &lt;= #{receiveTimeEnd}
        </if>
        <if test="userId != null and userId != ''">
            AND c.user_id = #{userId}
        </if>
        <if test="assistantId != null and assistantId != ''">
            AND c.assistant_id = #{assistantId}
        </if>
        <if test="station != null and station != '' and station != '总部'">
            <choose>
                <!-- 当 station 是 '九堡彭埠' 时，使用 in 条件 -->
                <when test="station == '九堡彭埠'">
                    AND c.case_location in ('九堡', '彭埠')
                </when>
                <!-- 其他情况使用等于条件 -->
                <otherwise>
                    AND c.case_location = #{station}
                </otherwise>
            </choose>
        </if>
        <!-- 万能搜索：案由、原告、被告、案号、助理用户名、处理人用户名 -->
        <if test="keyword != null and keyword != ''">
            AND (
            c.case_name LIKE CONCAT('%', #{keyword}, '%')
            OR c.plaintiff_name LIKE CONCAT('%', #{keyword}, '%')
            OR c.defendant_name LIKE CONCAT('%', #{keyword}, '%')
            OR c.case_number LIKE CONCAT('%', #{keyword}, '%')
            OR CAST(c.receipt_number AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
            OR CAST(c.penghe_case_number AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
            OR CAST(c.mediate_case_number AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
            OR a.username LIKE CONCAT('%', #{keyword}, '%')
            OR u.username LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
    </select>

    <!-- 查询所有案件总数 -->
    <select id="countByTaskId" resultType="int">
        SELECT COUNT(*) FROM case_info
        WHERE 1=1
        <if test="taskId != null and taskId != ''">
            AND task_id = #{taskId}
        </if>
    </select>

    <!-- 根据用户ID查询生效的案件 -->
    <select id="countActiveByUserId" resultType="int">
        SELECT COUNT(*) FROM case_info
        WHERE status in ('已领取' ,'反馈' ,'延期')
        <if test="userId != null and userId != ''">
            AND user_id = #{userId}
        </if>

    </select>

    <!-- 根据用户ID查询生效的案件 -->
    <select id="countActiveReceiveByUserId" resultType="int">
        SELECT COUNT(*) FROM case_info
        WHERE status in ('已领取' ,'反馈' ,'延期')
        <if test="userId != null and userId != ''">
            AND user_id = #{userId}
        </if>
        <if test="receiveType != null and receiveType != ''">
            AND receive_type = #{receiveType}
        </if>

    </select>


    <update id="updateReturnStatus">
        UPDATE case_info
        SET status = #{status},
            return_reason = #{returnReason}
        WHERE case_id = #{caseId}
    </update>

    <!-- 分页查询案件 -->
    <select id="selectCasePage" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT *,a.username as assistantName, t.task_name as taskName  FROM case_info c
        LEFT JOIN user u ON c.user_id = u.user_id
        LEFT JOIN user a ON c.assistant_id = a.user_id
        LEFT JOIN task t ON c.task_id = t.task_id
        WHERE 1=1
        <if test="caseName != null and caseName != ''">
            AND case_name LIKE CONCAT(#{caseName}, '%')
        </if>
        <!-- 多选状态优先，其次特殊标识，最后单状态 -->
        <if test="statusList != null and statusList.size() > 0">
            AND c.status IN
            <foreach collection="statusList" item="st" open="(" separator="," close=")">
                #{st}
            </foreach>
        </if>
        <if test="(statusList == null or statusList.size() == 0) and status != null and status != '' and status != '我的案件' and status != '我的待办'">
            AND c.status = #{status}
        </if>
        <if test="(statusList == null or statusList.size() == 0) and status != null and status != '' and status == '我的案件'">
            AND c.status NOT IN ('退回' ,'调解失败')
        </if>
        <if test="(statusList == null or statusList.size() == 0) and status != null and status != '' and status == '我的待办'">
            AND c.status NOT IN ('退回' ,'调解失败','结案')
        </if>
        <if test="caseNumber != null and caseNumber != ''">
            AND c.case_number LIKE CONCAT('%', #{caseNumber}, '%')
        </if>
        <if test="plaintiff != null and plaintiff != ''">
            AND c.plaintiff_name LIKE CONCAT('%', #{plaintiff}, '%')
        </if>
        <if test="defendant != null and defendant != ''">
            AND c.defendant_name LIKE CONCAT('%', #{defendant}, '%')
        </if>
        <if test="receiveTimeStart != null and receiveTimeStart != ''">
            AND c.court_receive_time &gt;= #{receiveTimeStart}
        </if>
        <if test="receiveTimeEnd != null and receiveTimeEnd != ''">
            AND c.court_receive_time &lt;= #{receiveTimeEnd}
        </if>
        <if test="userId != null and userId != ''">
            AND c.user_id = #{userId}
        </if>
        <if test="assistantId != null and assistantId != ''">
            AND c.assistant_id = #{assistantId}
        </if>
        <if test="station != null and station != '' and station != '总部'">
            <choose>
                <!-- 当 station 是 '九堡彭埠' 时，使用 in 条件 -->
                <when test="station == '九堡彭埠'">
                    AND c.case_location in ('九堡', '彭埠')
                </when>
                <!-- 其他情况使用等于条件 -->
                <otherwise>
                    AND c.case_location = #{station}
                </otherwise>
            </choose>
        </if>
        <!-- 万能搜索：案由、原告、被告、案号、助理用户名、处理人用户名 -->
        <if test="keyword != null and keyword != ''">
            AND (
                c.case_name LIKE CONCAT('%', #{keyword}, '%')
                OR c.plaintiff_name LIKE CONCAT('%', #{keyword}, '%')
                OR c.defendant_name LIKE CONCAT('%', #{keyword}, '%')
                OR c.case_number LIKE CONCAT('%', #{keyword}, '%')
                OR CAST(c.receipt_number AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                OR CAST(c.penghe_case_number AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                OR CAST(c.mediate_case_number AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
                OR a.username LIKE CONCAT('%', #{keyword}, '%')
                OR u.username LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        <if test="sortField != null and sortField != ''">
            ORDER BY
            <choose>
                <when test="sortField == 'caseNumber'">c.case_number,c.case_id</when>
                <when test="sortField == 'receiveTime'">c.receive_time,c.case_id</when>
                <when test="sortField == 'returnCourtTime'">c.return_court_time,c.case_id</when>
                <otherwise>c.updated_time,c.case_id</otherwise>
            </choose>
            <if test="sortOrder != null and sortOrder == 'desc'"> DESC </if>
            <if test="sortOrder != null and sortOrder == 'asc'"> ASC </if>
        </if>
        <if test="sortField == null or sortField == ''">
            ORDER BY c.updated_time,c.case_id DESC
        </if>
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 根据任务ID查询案件 -->
    <select id="selectByTaskId" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE task_id = #{taskId} order by case_id DESC
    </select>

    <!-- 根据任务ID查询案件 -->
    <select id="selectByCaseId" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT
            c.*,
            u.username,
            a.username as assistantName
        FROM
            case_info c
                LEFT JOIN user u ON c.user_id = u.user_id
                LEFT JOIN user a ON c.assistant_id = a.user_id
        WHERE c.case_id = #{caseId} limit 1
    </select>

    <!-- 根据用户ID查询案件 -->
    <select id="selectByUserId" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE user_id = #{userId} order by case_id DESC
    </select>

    <!-- 根据状态查询案件 -->
    <select id="selectByStatus" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE status = #{status} order by case_id DESC
    </select>

    <!-- 添加：前缀模糊搜索（只匹配以输入内容开头的案由） -->
    <select id="selectByCaseNameLikePrefix" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE case_name LIKE CONCAT(#{caseName}, '%')  order by case_id DESC
    </select>

    <!-- 关联查询案件列表（包含处理人用户名） -->
    <select id="selectCasesWithUsername" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT
            c.*,
            u.username,
            a.username as assistantName
        FROM
            case_info c
                LEFT JOIN user u ON c.user_id = u.user_id
                LEFT JOIN user a ON c.assistant_id = a.user_id
        ORDER BY c.case_id DESC
    </select>

    <!-- 根据状态关联查询（包含处理人用户名） -->
    <select id="selectCasesByStatusWithUsername" parameterType="String" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT
            c.*,
            u.username
        FROM
            case_info c
                LEFT JOIN
            user u ON c.user_id = u.user_id
        WHERE
            c.status = #{status}
        ORDER BY c.case_id DESC
    </select>

    <select id="selectMyCasesWithUsername" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT
            c.*,
            u.username  as assistantName
        FROM
            case_info c
                LEFT JOIN
            user u ON c.assistant_id = u.user_id
        WHERE
            c.user_id = #{userId} and c.status!='退回' and c.status!='失败'
        ORDER BY c.case_id DESC
    </select>

    <select id="selectAssistantCasesWithUsername" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT
            c.*,
            u.username as userName
        FROM
            case_info c
                LEFT JOIN
            user u ON c.user_id = u.user_id
        WHERE
            c.assistant_id = #{userId}
        ORDER BY c.case_id DESC
    </select>


    <select id="selectByStatusList" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE 1=1
        AND (
        status IN
        <foreach collection="statusList" item="status" open="(" separator="," close=")">
            #{status}
        </foreach>
        <if test="taskId != null and taskId != ''">
            OR (status='已领取' AND task_id=#{taskId})
        </if>
        )
        <if test="caseName != null and caseName != ''">
           AND case_name LIKE CONCAT('%', #{caseName}, '%')
        </if>
        <if test="station != null and station != '' and station != '总部'">
            <choose>
                <!-- 当 station 是 '九堡彭埠' 时，使用 in 条件 -->
                <when test="station == '九堡彭埠'">
                    AND case_location in ('九堡', '彭埠')
                </when>
                <!-- 其他情况使用等于条件 -->
                <otherwise>
                    AND case_location = #{station}
                </otherwise>
            </choose>
        </if>
        ORDER BY case_id DESC
    </select>

    <!-- 更新案件为调解失败状态 -->
    <update id="updateCompleteStatus">
        UPDATE case_info
        SET
            status = #{status},
            completion_remark = #{completionRemark},
            return_court_time = #{returnCourtTime},
            updated_time = NOW()
        WHERE case_id = #{caseId}
    </update>

    <!-- 查询最大收款单号（仅统计无字母前缀的纯数字收款单号，用于老规则） -->
    <select id="selectMaxReceiptNumber" resultType="java.lang.Integer">
        SELECT MAX(CAST(receipt_number AS UNSIGNED))
        FROM case_info
        /* 仅保留完全为数字的收款单号，这里假定纯数字即为“无前缀” */
        WHERE receipt_number IS NOT NULL
          AND receipt_number REGEXP '^[0-9]+'
    </select>
    <!-- 查询最大澎和案件号 -->
    <select id="selectMaxPengheCaseNumber" resultType="java.lang.Integer">
        SELECT MAX(penghe_case_number) FROM case_info
    </select>

    <!-- 查询本部和四季青的青枫号最大值，复用 penghe_case_number 字段 -->
    <select id="selectMaxQingfengCaseNumber" resultType="java.lang.Integer">
        SELECT MAX(penghe_case_number)
        FROM case_info
        WHERE case_location IN ('四季青')
    </select>

    <!-- 查询除本部/四季青之外其他驻点的澎和号最大值，复用 penghe_case_number 字段 -->
    <select id="selectMaxPengheCaseNumberForOtherStations" resultType="java.lang.Integer">
        SELECT MAX(penghe_case_number)
        FROM case_info
        WHERE (case_location IS NULL OR case_location NOT IN ('四季青'))
    </select>

    <!-- 查询本部和四季青最大收款单号（S0XX格式） -->
    <select id="selectMaxReceiptNumberForBenbu" resultType="java.lang.String">
        SELECT MAX(receipt_number) FROM case_info
        WHERE case_location IN ('本部','四季青') AND receipt_number LIKE 'S0%'
    </select>

    <!-- 查询凯旋街道最大收款单号（KXX格式） -->
    <select id="selectMaxReceiptNumberForKaixuan" resultType="java.lang.String">
        SELECT MAX(receipt_number) FROM case_info
        WHERE case_location = '凯旋街道' AND receipt_number LIKE 'K%'
    </select>

    <!-- 查询闸弄口最大收款单号（ZXX格式） -->
    <select id="selectMaxReceiptNumberForZhanongkou" resultType="java.lang.String">
        SELECT MAX(receipt_number) FROM case_info
        WHERE case_location = '闸弄口' AND receipt_number LIKE 'Z%'
    </select>

    <!-- 按年份前缀查询四季青青枫号最大值，格式如 2026-001 -->
    <select id="selectMaxQingfengCaseNumberForYear" resultType="java.lang.String">
        SELECT MAX(penghe_case_number)
        FROM case_info
        WHERE case_location IN ('四季青')
          AND penghe_case_number LIKE CONCAT(#{yearPrefix}, '%')
    </select>

    <!-- 按年份前缀查询非四季青澎和号最大值，格式如 2026-001 -->
    <select id="selectMaxPengheCaseNumberForYear" resultType="java.lang.String">
        SELECT MAX(penghe_case_number)
        FROM case_info
        WHERE (case_location IS NULL OR case_location NOT IN ('四季青'))
          AND penghe_case_number LIKE CONCAT(#{yearPrefix}, '%')
    </select>

    <!-- 按年份前缀查询本部+四季青最大 S0XX 收款单号，例如 2026-S070 -->
    <select id="selectMaxReceiptNumberForBenbuYear" resultType="java.lang.String">
        SELECT MAX(receipt_number) FROM case_info
        WHERE case_location IN ('本部','四季青')
          AND receipt_number LIKE CONCAT(#{yearPrefix}, 'S0%')
    </select>

    <!-- 按年份前缀查询凯旋街道最大 KXX 收款单号，例如 2026-K01 -->
    <select id="selectMaxReceiptNumberForKaixuanYear" resultType="java.lang.String">
        SELECT MAX(receipt_number) FROM case_info
        WHERE case_location = '凯旋街道'
          AND receipt_number LIKE CONCAT(#{yearPrefix}, 'K%')
    </select>

    <!-- 按年份前缀查询闸弄口最大 ZXX 收款单号，例如 2026-Z01 -->
    <select id="selectMaxReceiptNumberForZhanongkouYear" resultType="java.lang.String">
        SELECT MAX(receipt_number) FROM case_info
        WHERE case_location = '闸弄口'
          AND receipt_number LIKE CONCAT(#{yearPrefix}, 'Z%')
    </select>

    <!-- 按年份前缀查询其他驻点最大纯数字收款单号，例如 2026-070 -->
    <select id="selectMaxReceiptNumberForOthersYear" resultType="java.lang.String">
        SELECT MAX(receipt_number) FROM case_info
        WHERE (case_location IS NULL OR case_location NOT IN ('本部','四季青','凯旋街道','闸弄口'))
          AND receipt_number LIKE CONCAT(#{yearPrefix}, '%')
          AND SUBSTRING(receipt_number, LENGTH(#{yearPrefix}) + 1) REGEXP '^[0-9]+'
    </select>

    <!-- 按年份前缀查询最大人调号，格式如 2026彭人003 -->
    <select id="selectMaxMediateCaseNumberForYear" resultType="java.lang.String">
        SELECT MAX(mediate_case_number)
        FROM case_info
        WHERE mediate_case_number LIKE CONCAT(#{yearPrefix}, '%')
    </select>

    <!-- 按年份前缀查询最大人调号并加行锁（并发安全生成序列） -->
    <select id="selectMaxMediateCaseNumberForYearForUpdate" resultType="java.lang.String">
        SELECT MAX(mediate_case_number)
        FROM case_info
        WHERE mediate_case_number LIKE CONCAT(#{yearPrefix}, '%')
        FOR UPDATE
    </select>

</mapper>