<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.managementsystem.mapper.CaseInfoMapper">

    <!-- 基础结果集映射 -->
    <resultMap id="CaseResultMap" type="com.example.managementsystem.entity.CaseInfo">
        <id property="caseId" column="case_id"/>
        <result property="caseNumber" column="case_number"/>
        <result property="caseName" column="case_name"/>
        <result property="amount" column="amount"/>
        <result property="taskId" column="task_id"/>
        <result property="taskName" column="task_name"/>
        <result property="status" column="status"/>
        <result property="userId" column="user_id"/>
        <result property="completionNotes" column="completion_notes"/>
        <result property="caseLocation" column="case_location"/>
        <result property="courtReceiveTime" column="court_receive_time"/>
        <result property="plaintiffName" column="plaintiff_name"/>
        <result property="defendantName" column="defendant_name"/>
        <result property="assistantId" column="assistant_id"/>
        <result property="assistantName" column="assistant_name"/>
        <result property="username" column="username"/>
        <result property="createdTime" column="created_time"/>
        <result property="updatedTime" column="updated_time"/>
    </resultMap>

    <!-- 查询所有案件总数 -->
    <select id="countAllCases" resultType="int">
        SELECT COUNT(*) FROM case_info
    </select>

    <!-- 分页查询案件 -->
    <select id="selectCasePage" resultMap="CaseResultMap">
        SELECT * FROM case_info
        ORDER BY created_time DESC
            LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 根据任务ID查询案件 -->
    <select id="selectByTaskId" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE task_id = #{taskId}
    </select>

    <!-- 根据用户ID查询案件 -->
    <select id="selectByUserId" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE user_id = #{userId}
    </select>

    <!-- 根据状态查询案件 -->
    <select id="selectByStatus" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE status = #{status}
    </select>

    <!-- 添加：前缀模糊搜索（只匹配以输入内容开头的案由） -->
    <select id="selectByCaseNameLikePrefix" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE case_name LIKE CONCAT(#{caseName}, '%')  -- 前缀匹配
    </select>

    <!-- 关联查询案件列表（包含处理人用户名） -->
    <select id="selectCasesWithUsername" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT
            c.*,
            u.username,
            a.username as assistantName
        FROM
            case_info c
                LEFT JOIN user u ON c.user_id = u.user_id
                LEFT JOIN user a ON c.assistant_id = a.user_id
    </select>

    <!-- 根据状态关联查询（包含处理人用户名） -->
    <select id="selectCasesByStatusWithUsername" parameterType="String" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT
            c.*,
            u.username
        FROM
            case_info c
                LEFT JOIN
            user u ON c.user_id = u.user_id
        WHERE
            c.status = #{status}
    </select>

    <select id="selectMyCasesWithUsername" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT
            c.*,
            u.username
        FROM
            case_info c
                LEFT JOIN
            user u ON c.user_id = u.user_id
        WHERE
            c.user_id = #{userId}
    </select>



</mapper>