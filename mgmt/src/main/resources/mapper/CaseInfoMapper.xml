<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.managementsystem.mapper.CaseInfoMapper">



    <update id="removeTaskId">
        UPDATE case_info
        SET task_id = NULL
        WHERE case_id = #{caseId}
    </update>

    <!-- 查询所有案件总数 -->
    <select id="countAllCases" resultType="int">
        SELECT COUNT(*) FROM case_info
        WHERE 1=1
        <if test="caseName != null and caseName != ''">
            AND case_name LIKE CONCAT(#{caseName}, '%')
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
    </select>

    <!-- 查询所有案件总数 -->
    <select id="countByTaskId" resultType="int">
        SELECT COUNT(*) FROM case_info
        WHERE 1=1
        <if test="taskId != null and taskId != ''">
            AND task_id = #{taskId}
        </if>
    </select>

    <!-- 根据用户ID查询生效的案件 -->
    <select id="countActiveByUserId" resultType="int">
        SELECT COUNT(*) FROM case_info
        WHERE status='已领取'
        <if test="userId != null and userId != ''">
            AND user_id = #{userId}
        </if>

    </select>


    <update id="updateReturnStatus">
        UPDATE case_info
        SET status = #{status},
            return_reason = #{returnReason}
        WHERE case_id = #{caseId}
    </update>

    <!-- 分页查询案件 -->
    <select id="selectCasePage" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT *,a.username as assistantName, t.task_name as taskName  FROM case_info c
                          LEFT JOIN user u ON c.user_id = u.user_id
                          LEFT JOIN user a ON c.assistant_id = a.user_id
                          LEFT JOIN task t ON c.task_id = t.task_id
        WHERE 1=1
        <if test="caseName != null and caseName != ''">
            AND case_name LIKE CONCAT(#{caseName}, '%')
        </if>
        <if test="status != null and status != ''">
            AND c.status = #{status}
        </if>
        ORDER BY c.created_time DESC
            LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 根据任务ID查询案件 -->
    <select id="selectByTaskId" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE task_id = #{taskId}
    </select>

    <!-- 根据用户ID查询案件 -->
    <select id="selectByUserId" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE user_id = #{userId}
    </select>

    <!-- 根据状态查询案件 -->
    <select id="selectByStatus" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE status = #{status}
    </select>

    <!-- 添加：前缀模糊搜索（只匹配以输入内容开头的案由） -->
    <select id="selectByCaseNameLikePrefix" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE case_name LIKE CONCAT(#{caseName}, '%')  -- 前缀匹配
    </select>

    <!-- 关联查询案件列表（包含处理人用户名） -->
    <select id="selectCasesWithUsername" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT
            c.*,
            u.username,
            a.username as assistantName
        FROM
            case_info c
                LEFT JOIN user u ON c.user_id = u.user_id
                LEFT JOIN user a ON c.assistant_id = a.user_id
    </select>

    <!-- 根据状态关联查询（包含处理人用户名） -->
    <select id="selectCasesByStatusWithUsername" parameterType="String" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT
            c.*,
            u.username
        FROM
            case_info c
                LEFT JOIN
            user u ON c.user_id = u.user_id
        WHERE
            c.status = #{status}
    </select>

    <select id="selectMyCasesWithUsername" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT
            c.*,
            u.username
        FROM
            case_info c
                LEFT JOIN
            user u ON c.user_id = u.user_id
        WHERE
            c.user_id = #{userId}
    </select>

    <select id="selectAssistantCasesWithUsername" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT
            c.*,
            u.username
        FROM
            case_info c
                LEFT JOIN
            user u ON c.assistant_id = u.user_id
        WHERE
            c.assistant_id = #{userId}
    </select>


    <select id="selectByStatusList" resultType="com.example.managementsystem.entity.CaseInfo">
        SELECT * FROM case_info
        WHERE 1=1
        AND (
        status IN
        <foreach collection="statusList" item="status" open="(" separator="," close=")">
            #{status}
        </foreach>
        <if test="taskId != null and taskId != ''">
            OR (status='已领取' AND task_id=#{taskId})
        </if>
        )
        <if test="caseName != null and caseName != ''">
           AND case_name LIKE CONCAT('%', #{caseName}, '%')
        </if>

    </select>






</mapper>