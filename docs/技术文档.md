# 法律案件管理系统（后台）— 技术文档

> 文档面向：后端/前端开发、测试、运维
>
> 覆盖：工程结构、运行方式、鉴权与权限边界、核心模块/接口、定时任务、数据与状态机、常见排查。

---

## 1. 工程结构

仓库为多模块 Maven 工程：

- 根目录：`management-system`（packaging: `pom`）
- 子模块：`mgmt/`（Spring Boot 应用）

主要目录：

- `mgmt/src/main/java/com/example/managementsystem/`
  - `controller/`：HTTP 接口
  - `service/` `service/impl/`：业务逻辑
  - `mapper/`：MyBatis-Plus Mapper 接口
  - `entity/`：实体
  - `dto/`：请求/响应 DTO（如 `CasePageRequest`, `UserSession` 等）
  - `task/`：定时任务（如 `CaseAutoReturnTask`）
- `mgmt/src/main/resources/`
  - `mapper/*.xml`：MyBatis XML
  - `static/`：内置前端（HTML + JS）

---

## 2. 技术栈

- Java 8
- Spring Boot 2.7.15
- MyBatis-Plus 3.5.3.1
- MySQL 8.x
- Apache POI（Excel 导入导出）
- OSS 适配：`OssFileStorageAdapter`（上传/下载）

---

## 3. 配置与启动

### 3.1 配置文件

根目录 `application.yml`（注意：本仓库配置了本地数据库示例）：

- `spring.datasource.url/username/password`
- `server.port=8090`
- `server.servlet.context-path=/api`
- `mybatis-plus.mapper-locations=classpath*:mapper/**/*.xml`

### 3.2 启动入口

- `mgmt/src/main/java/com/example/managementsystem/ManagementSystemApplication.java`
  - `@SpringBootApplication`
  - `@MapperScan("com.example.managementsystem.mapper")`
  - `@EnableScheduling`（开启定时任务）

---

## 4. 会话与鉴权（Session）

系统使用 `HttpSession` 存储登录用户：

- Session Key：`currentUser`
- 类型：`com.example.managementsystem.dto.UserSession`

很多接口会执行：

- `UserSession currentUser = (UserSession) session.getAttribute("currentUser");`

并依据：

- `currentUser.roleType`：中文角色类型字符串（可能逗号分隔）
- `currentUser.station`：驻点（可能逗号分隔）
- `currentUser.roleIds`：role id 列表（逗号分隔）

**权限判断核心**：

- “总部管理员”通常需要同时满足：
  - `roleType` 包含“管理员”
  - `station` 列表包含“总部”

代码中典型实现参见：`TaskController#isHeadquartersAdmin` / `requireHeadquartersAdmin`。

---

## 5. 核心模块与接口概览

> 以下为代码扫描到的主要接口（不穷举），路径均基于 `server.servlet.context-path=/api`。

### 5.1 登录与用户/角色

- `POST /login`、`GET /logout`（详见 `LoginController`）
- `GET /user/*`（用户管理）
- `GET /role/*`（角色管理）

### 5.2 案件（Case）

控制器：`CaseInfoController`，路径前缀 `/case`

- `POST /case/page`：分页查询（RequestBody：`CasePageRequest`）
- `GET /case/{id}`：按 id 查询
- `GET /case/detail/{id}`：详情（前端使用）
- `GET /case/history/{id}`：流转历史
- `POST /case`：新增案件
- `POST /case/import-excel`：导入案件
- `POST /case/update-task`：更新案件关联的 taskId
- `POST /case/batch-update-task`：批量更新 taskId
- 还有批量分派、退回、结案等扩展接口（在文件后半部分）

#### 5.2.1 `taskId` 过滤要求

前端在“查看案件包关联案件”场景会走 `/case/page` 并携带 `taskId` 字段。

技术债描述：

- 目前 `CasePageRequest` 中存在 `taskId` 字段（或请求体包含 taskId），但 service/mapper 查询未使用该字段过滤。

修复方向（建议，实际实现需查看 mapper/sql）：

- 在 `CaseInfoServiceImpl#getCasePage(CasePageRequest request)` 中加入 `taskId` 条件：
  - 若 `request.taskId != null`，加 `eq(CaseInfo::getTaskId, request.taskId)`
  - 或在 XML 中追加 `AND task_id = #{taskId}`

### 5.3 案件包（Task）

控制器：`TaskController`，路径前缀 `/task`

关键接口：

- `GET /task/page`：分页查询案件包
  - 权限规则：
    - `roleType` 含“临时调解员”：直接返回空
    - 总部管理员：可查询全部驻点（`stationFilter=null`）
    - 非总部：`stationFilter=userStations`（只看自己驻点）
- `POST /task`：新增案件包（仅总部管理员）
- `PUT /task`：编辑案件包（仅总部管理员）
- `DELETE /task/{id}`：删除案件包（仅总部管理员）
- `POST /task/publish`：发布案件包（仅总部管理员）
- `POST /task/assign`：分派案件包给用户（仅总部管理员）
- `POST /task/assign-cases`：关联案件到案件包（仅总部管理员）
- `POST /task/receive`：领取案件包（调解员/允许角色）

#### 5.3.1 非总部管理员只读

前端：`static/task-management.js` 用 `isHeadquartersAdminUser()` 控制按钮展示；
后端：`TaskController` 对写接口使用 `requireHeadquartersAdmin(session)` 强制校验。

仍需注意的点：

- **导出接口**如在后端实现，应同样按站点过滤返回。
- “查看案件包关联案件”走 `/case/page`，需与第 5.2.1 里 taskId 过滤联动。

### 5.4 系统文件（SystemFile）

控制器：`SystemFileController`，路径前缀 `/systemFile`

- `GET /systemFile`：支持筛选参数
  - `fileType`、`secretLevel`、`fileNameKeyword`
- `POST /systemFile/upload`：上传（仅管理员）
- `PUT /systemFile/{id}`：更新文件类型/保密等级（仅管理员）
- `DELETE /systemFile/{id}`：删除（仅管理员）
- `GET /systemFile/download/{id}`：下载（所有角色可调用）

安全建议：

- 目前下载接口只按 id 下载，若机密文件需要更严格控制，建议服务端也做二次鉴权：
  - `secretLevel=机密` 时仅管理员下载。

前端：`static/system-file.js` 已支持筛选 UI 与 querystring 组装。

---

## 6. 状态机与关键规则

### 6.1 案件状态机（简化）

常见状态：

`待领取` → `已领取` → `反馈` → `延期|待结案` → `结案`

中断状态：

- `退回`：归还入池/回到待处理
- `调解失败`：失败结论

> 注意：系统当前使用“中文字符串”为状态值，属于强耦合设计；改名需全局替换（前端按钮判断、后端规则判断、SQL 过滤）。

### 6.2 `CaseAutoReturnTask`（每日 02:00）

文件：`mgmt/src/main/java/com/example/managementsystem/task/CaseAutoReturnTask.java`

职责：

- 每天凌晨 2 点执行一次。
- 读取两类“待检查”的案件：
  - `caseInfoService.getSelfReceivedCheckableCases()`：自行领取且状态为 `已领取/反馈` 的案件
  - `caseInfoService.getAssignedCheckableCases()`：被分派且状态为 `已领取/反馈` 的案件
- 计算 `daysSinceReceived = DAYS.between(receiveTime, now)`
- 若满足规则则：
  1) 更新案件状态为 `退回`
  2) 写入 `returnReason`（包含超时规则与之前状态）
  3) 插入 `CaseFlowHistory`（action=自动退回、beforeStatus/afterStatus、operator=System）

规则细节：

- 自行领取：
  - `>3天` 且状态 `已领取` → 退回
  - `>15天` 且状态 `反馈` → 退回
- 被分派：
  - `>10天` → 退回
  - 特例：`caseLocation==笕桥` 且 `<15天` 跳过退回

---

## 7. 前端（内置静态资源）

目录：`mgmt/src/main/resources/static/`

特点：

- 无构建流程（非 Vue/React），直接通过 `index.html` + 多个 `*.js` 实现模块页面。
- 与后端同域部署，通过 `fetch('/api/...')` 调用接口，并启用 `credentials: 'include'` 使用 session。

关键 JS：

- `common.js`：封装 `request()` 等通用方法
- `my-cases.js`：我的案件
- `case-management.js`：案件管理
- `task-management.js`：案件包管理（含总部管理员写权限控制）
- `task-receive.js`：案件包领取
- `system-file.js`：系统文件（含筛选）

---

## 8. 数据库与 SQL

- SQL 脚本位于：`mgmt/sql/`
- MyBatis XML：`mgmt/src/main/resources/mapper/`

建议维护方式：

- 将“状态枚举”、“角色/驻点字符串”整理为常量或字典表，避免散落在前后端。

---

## 9. 测试与联调建议

### 9.1 冒烟检查清单

- 登录后 `currentUser` 是否正确写入 session。
- `/task/page`：
  - 总部管理员能看到全部驻点
  - 非总部管理员仅能看到自己驻点
  - 临时调解员返回空
- `/case/page`：在携带 `taskId` 时是否能正确只返回关联案件
- 系统文件筛选：`fileType/secretLevel/fileNameKeyword` 能有效过滤
- 机密文件下载：非管理员是否被正确限制（若已加后端限制）

### 9.2 常见问题排查

- 404：注意所有接口前缀 `/api`
- 登录后仍提示未登录：浏览器是否允许 cookie，前端请求是否带 `credentials: 'include'`
- MyBatis 找不到 XML：检查 `mybatis-plus.mapper-locations`
- 定时任务没执行：确认 `@EnableScheduling` 是否生效、应用是否持续运行

---

## 10. 后续优化建议（可选）

- 统一 RBAC：将“总部管理员/非总部管理员”判定逻辑抽到一个 `AuthUtil`，避免 controller 重复。
- 对敏感下载、导出接口增加服务端鉴权与审计日志。
- 将中文状态值改为枚举 code（数据库存 code、前端映射文案）。
- 为 `/case/page`、`/task/page` 增加更清晰的 OpenAPI 文档（Springdoc）。

