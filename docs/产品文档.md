# 法律案件管理系统（后台）— 产品文档

> 文档面向：产品、运营、业务管理员、交付/实施
>
> 覆盖范围：本仓库 `leagal-management-system-backend` 对应的系统能力（后端 + 内置静态前端页面）。
>
> 说明：本文档基于当前工程代码（Spring Boot + MyBatis-Plus + 静态 HTML/JS）整理，字段/权限以代码实现为准。

---

## 1. 背景与目标

本系统用于管理“法院/驻点”相关的 **案件** 全流程，以及用于批量分发案件的 **案件包（Task）**。

核心目标：

- 将案件按驻点、人员角色进行分配与处理跟踪。
- 支持案件从领取、反馈、延期、待结案、结案等状态的流转。
- 支持总部管理员对案件包/案件进行集中管理，非总部管理员只读查看自己驻点数据。
- 提供导入导出能力、系统文件管理能力（模板/制度文档）。

---

## 2. 角色与权限（非常重要）

系统通过登录会话中的 `UserSession` 进行权限判断，前端也会做“按钮级”隐藏/禁用，但**最终以服务端权限校验为准**。

### 2.1 角色概念

- **总部管理员**：`roleType` 包含“管理员”，并且用户驻点（`station`）包含“总部”。
- **非总部管理员**：`roleType` 包含“管理员”，但驻点不包含“总部”。可能拥有多个驻点（如 “彭埠,笕桥”）。
- **案件助理**：参与案件辅助分配与处理。
- **调解员**：可领取案件包、处理案件。
- **临时调解员**：根据现有逻辑，**不展示案件包**（不可领取案件包）。

> 备注：系统中“驻点”是授权的最小维度之一，管理员或用户可能拥有多个驻点。

### 2.2 权限矩阵（摘要）

| 功能模块 | 总部管理员 | 非总部管理员 | 调解员 | 临时调解员 |
|---|---|---|---|---|
| 案件包管理（Task 管理 Tab） | 读写（创建/编辑/删除/发布/分派/关联案件等） | **只读**（仅看自己驻点案件包 + 查看关联案件 + 勾选导出） | 通常不使用 | 不涉及 |
| 案件包领取（Task Receive） | 可看全部（若开放） | 按站点规则（代码层视实现） | 可领取 | **不可见/不可领** |
| 我的案件（My Cases） | 按自身权限/分配 | 按自身权限/分配 | 按领取/分派 | 按业务规则 |
| 案件管理（Case Management） | 全部案件（含各驻点） | 通常按站点/角色过滤 | 视权限开放 | 视权限开放 |
| 系统文件（SystemFile）下载 | 可下载 | 可下载（机密文件有限制） | 可下载（机密文件有限制） | 可下载（机密文件有限制） |
| 系统文件上传/编辑/删除 | 仅管理员 | 仅管理员 | 否 | 否 |

**关于案件包管理只读要求（你最新确认）：**

- 非总部管理员在“案件包管理”Tab 下**全部只读**：
  - 只能看到自己驻点的案件包。
  - 可以查看案件包关联的案件列表。
  - 允许通过勾选框导出“他能看见的数据”。
  - 禁止：新增/编辑/删除/发布/分派/关联案件等所有写操作。

---

## 3. 核心对象与数据

### 3.1 案件（CaseInfo）

案件是业务核心，以案件号、案由、当事人、标的额等信息为主，并通过 `status` 字段体现流程。

常见字段（以页面展示为主）：

- `caseNumber`：案件号
- `caseName`：案由
- `caseLocation`：归属地/驻点（如 彭埠、笕桥、九堡彭埠、本部、四季青、凯旋街道、闸弄口 等）
- `plaintiff` / `defendant`：原告/被告
- `judgeName`：法官
- `assistantId`/`assistantName`：案件助理
- `receiveTime`：领取时间
- `returnReason`：退回原因
- `taskId`：所属案件包（可能为空）
- `caseCloseExt`：结案扩展信息（JSON 字符串），包含**付款流水 paymentFlows**等

#### 3.1.1 案件状态（status）

系统中出现/使用到的状态包括：

- `待领取`
- `已领取`
- `反馈`
- `延期`
- `待结案`
- `结案`
- `退回`
- `调解失败`

> 状态名称以中文字符串保存，前后端都直接使用这些字符串进行判断。

### 3.2 案件包（Task）

案件包用于批量组织一批案件，并进行“发布 -> 领取/分派”的操作。

常见字段：

- `taskId`：案件包 ID
- `taskName`：案件包名称
- `station`：案件包所属驻点
- `status`：案件包状态（常见：`待发布`、`待领取`、`已领取`）
- `receiveTime`：领取时间
- `ownerName`：领取人/负责人
- `caseCount`：关联案件数量（列表展示字段）

---

## 4. 关键业务流程

### 4.1 案件包管理（总部管理员为主）

1. 总部管理员新建案件包（默认状态 `待发布`）。
2. 总部管理员将案件关联到案件包（关联后可在“查看案件”里看到案件列表）。
3. 总部管理员发布案件包：状态变更为 `待领取`。
4. 调解员在“案件包领取”页面选择案件包领取，领取成功后案件包状态通常变为 `已领取`，并将包内案件分派给领取人处理。

非总部管理员：只能查看“自己驻点”的案件包以及关联案件，并可以导出。

### 4.2 案件领取与处理

- 案件可通过案件包领取后分配给处理人。
- 处理人对案件进行反馈、申请延期、提交结案信息等。

典型路径（示例）：

`待领取` → `已领取` → `反馈` → `延期` / `待结案` → `结案`

也可能因超时或规则触发：

`已领取/反馈` → `退回`（自动退回任务或人工操作）

### 4.3 自动退回（定时任务）

系统包含定时任务 `CaseAutoReturnTask`（每日凌晨 2 点执行），用于对长期未处理的案件自动退回，并记录流转历史。

退回规则（摘要）：

- 自行领取：
  - 领取后超过 3 天仍处于 `已领取` → 自动退回
  - 领取后超过 15 天仍处于 `反馈` → 自动退回
- 被分派：
  - 领取后超过 10 天仍处于 `已领取/反馈`（或其他可检查状态）→ 自动退回
  - 特例：`笕桥` 地点的案件，小于 15 天不自动退回

退回后：

- 将 `status` 设置为 `退回`
- 写入 `returnReason`
- 写入流转历史（CaseFlowHistory）：动作“自动退回”，操作者“System”

---

## 5. 页面与功能点（内置静态前端）

> 系统前端在后端工程内置：`mgmt/src/main/resources/static/`。

主要页面/Tab（以导航为准）：

- 登录：`login.html`
- 首页工作台：`workspace.js`
- 我的案件：`my-cases.js`
- 案件管理：`case-management.js`
- 案件包管理：`task-management.js`
- 案件包领取：`task-receive.js`
- 用户管理：`user-management.js`
- 角色管理：`role-management.js`
- 系统文件：`system-file.js`

### 5.1 我的案件

- 支持关键词搜索、更多条件筛选。
- 支持按状态筛选（全部 / 已领取 / 反馈 / 延期 / 待结案 / 结案）。
- 支持查看案件详情与历史。
- 支持导出“我的案件”。
- 支持结案信息补录（结案扩展信息中包含付款流水）。

### 5.2 案件管理

- 适用于管理员/助理等角色对全量案件进行管理。
- 支持高级筛选、状态多选导出、导入 Excel、批量分派等。
- 支持在 `结案` 状态下像 `待结案` 一样补充结案信息（含付款流水）。

### 5.3 案件包管理

- 列表展示案件包，支持搜索名称。
- 支持勾选导出。
- 总部管理员拥有新增/编辑/删除/关联案件/分派/发布等写权限。
- 非总部管理员只读：能看自己驻点数据 + 查看关联案件 + 勾选导出。

### 5.4 系统文件

- 所有用户可查看列表与下载（机密文件下载做权限限制）。
- 管理员可上传、编辑元信息（文件类型/保密等级）、删除。
- 支持按 **文件类型 / 保密等级 / 文件名关键字**筛选。

---

## 6. 导入导出

- 案件支持 Excel 导入（后端会校验字段并自动分配助理/生成案件号等）。
- 案件与案件包支持导出（前端触发下载）。

---

## 7. 常见问题（FAQ）

### Q1：临时调解员为什么看不到案件包？
A：系统在案件包分页接口中，对 `roleType` 包含“临时调解员”的用户直接返回空列表（不展示、不允许领取）。

### Q2：非总部管理员在案件包管理能做哪些操作？
A：只读：查看自己驻点的案件包 + 查看关联案件 + 勾选导出；不允许新增/编辑/删除/分派/关联/发布等写操作。

### Q3：机密系统文件谁能下载？
A：机密文件在前端做了限制：仅管理员显示可下载；后端下载接口当前未做强制权限校验时，建议由服务端补强（见技术文档）。

